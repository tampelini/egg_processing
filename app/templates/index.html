<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Egg Processing & Calibração</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* Ajustes para o grid/lista de cores */
    .top-cores {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 8px;
    }
    .cor-item {
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 6px 8px;
      background: #fafafa;
      color: #000; /* força texto preto */
    }
    .cor-swatch {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,0.2);
      flex-shrink: 0;
    }
    .cor-meta {
      font-size: 0.9rem;
      line-height: 1.2;
      color: #000;
    }
    .cor-meta .line {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 220px;
    }
    .claridade-box {
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h1>Processamento & Calibração</h1>
  <p class="sub">Escolha entre processar a imagem dos ovos (pipeline do <code>processamento.py</code>) ou calibrar via ColorChecker.</p>

  <div class="grid">

    <!-- OPÇÃO 1: PROCESSAR OVOS -->
    <section class="section">
      <h2>1) Processar ovos (processamento.py)</h2>
      <p class="hint">
        Envie a imagem dos ovos para segmentação, anotação e cálculo de cores. Este formulário posta para a rota
        <strong>"/"</strong> (função <code>index()</code>) e chama <code>processar_imagem()</code>.
      </p>

      <form method="post" enctype="multipart/form-data">
        <label for="file-ovos" class="file-label">Escolher imagem de ovos</label>
        <input id="file-ovos" type="file" name="imagem" accept="image/*" required />

        <div class="ajustes-box">
          <h3>Ajustes de imagem</h3>
          <p class="ajustes-hint">Valores com 1.00 mantêm o padrão (exceto EV/nitidez = 0.00).</p>
          <div class="ajustes-grid">
            <div class="ajuste">
              <div class="ajuste-head">
                <label for="ajuste-brilho">Brilho (HSV V)</label>
                <span class="ajuste-value" data-value-for="ajuste-brilho">{{ '%.2f' % ajustes.fator_v_backup }}</span>
              </div>
              <input id="ajuste-brilho" type="number" step="0.01" min="0.20" max="3.00" name="fator_v_backup" value="{{ '%.2f' % ajustes.fator_v_backup }}" data-decimals="2" />
              <small>&lt;1 escurece, &gt;1 clareia a imagem base.</small>
            </div>
            <div class="ajuste">
              <div class="ajuste-head">
                <label for="ajuste-contraste">Contraste</label>
                <span class="ajuste-value" data-value-for="ajuste-contraste">{{ '%.2f' % ajustes.fator_contraste }}</span>
              </div>
              <input id="ajuste-contraste" type="number" step="0.01" min="0.20" max="3.00" name="fator_contraste" value="{{ '%.2f' % ajustes.fator_contraste }}" data-decimals="2" />
              <small>Amplia ou reduz diferenças tonais.</small>
            </div>
            <div class="ajuste">
              <div class="ajuste-head">
                <label for="ajuste-saturacao">Saturação</label>
                <span class="ajuste-value" data-value-for="ajuste-saturacao">{{ '%.2f' % ajustes.fator_saturacao }}</span>
              </div>
              <input id="ajuste-saturacao" type="number" step="0.01" min="0.00" max="3.00" name="fator_saturacao" value="{{ '%.2f' % ajustes.fator_saturacao }}" data-decimals="2" />
              <small>&lt;1 dessatura, &gt;1 reforça as cores.</small>
            </div>
            <div class="ajuste">
              <div class="ajuste-head">
                <label for="ajuste-ev">Exposição (EV)</label>
                <span class="ajuste-value" data-value-for="ajuste-ev">{{ '%.2f' % ajustes.ev_exposicao }}</span>
              </div>
              <input id="ajuste-ev" type="number" step="0.05" min="-5.00" max="5.00" name="ev_exposicao" value="{{ '%.2f' % ajustes.ev_exposicao }}" data-decimals="2" />
              <small>Aplica ganho 2<sup>EV</sup> à imagem base.</small>
            </div>
            <div class="ajuste">
              <div class="ajuste-head">
                <label for="ajuste-nitidez">Nitidez</label>
                <span class="ajuste-value" data-value-for="ajuste-nitidez">{{ '%.2f' % ajustes.fator_nitidez }}</span>
              </div>
              <input id="ajuste-nitidez" type="number" step="0.05" min="-1.00" max="2.00" name="fator_nitidez" value="{{ '%.2f' % ajustes.fator_nitidez }}" data-decimals="2" />
              <small>Valores positivos realçam detalhes; negativos suavizam.</small>
            </div>
            <div class="ajuste">
              <div class="ajuste-head">
                <label for="ajuste-temperatura">Temperatura</label>
                <span class="ajuste-value" data-value-for="ajuste-temperatura">{{ '%.3f' % ajustes.fator_temperatura }}</span>
              </div>
              <input id="ajuste-temperatura" type="number" step="0.001" min="-1.000" max="1.000" name="fator_temperatura" value="{{ '%.3f' % ajustes.fator_temperatura }}" data-decimals="3" />
              <small>&gt;0 aquece (mais vermelho), &lt;0 esfria (mais azul).</small>
            </div>
          </div>
        </div>

        <button type="submit">Processar ovos</button>
      </form>

      <div class="result">
        {% if imagem %}
          <h3>Imagem processada</h3>
          <img src="data:image/png;base64,{{ imagem }}" alt="Resultado do processamento de ovos" />
        {% endif %}

        {% if ovos_info %}
          <div class="divider"></div>
          <h3>Informações de cor para cada ovo</h3>

          {% for ovo in ovos_info %}
            {% set HEX = ovo.hex or ovo.HEX %}
            {% set RGB = ovo.rgb or ovo.RGB %}
            {% set LAB = ovo.lab or ovo.LAB %}
            {% set LCH = ovo.lch or ovo.LCH %}
            {% set XYZ = ovo.xyz or ovo.XYZ %}
            {% set ACES = ovo.aces or ovo.ACES %}
            {% set ACEScg = ovo.acescg or ovo.ACEScg %}
            {% set LINSRGB = ovo.linsrgb or ovo.Linear_sRGB %}
            {% set CMYK = ovo.cmyk or ovo.CMYK %}
            {% set NUM = ovo.num or loop.index %}
            {% set ORI = ovo.orientacao or ovo.orientation or '-' %}
            {% set CTR = ovo.center or ovo.centro or '-' %}
            {% set TODAS = ovo.todas_cores or ovo.top_cores or [] %}
            {% set PREVIEW = TODAS[:8] %}

            <div class="ovo-card">
              <span class="cor-box" style="background: {{ HEX }}"></span>
              <div class="ovo-info">
                <h4>Ovo {{ NUM }}</h4>
                <div class="field"><strong>Centro:</strong> {{ CTR }}</div>
                <div class="field"><strong>Orientação:</strong> {{ ORI }}</div>
                <div class="field"><strong>RGB:</strong> {{ RGB }}</div>
                <div class="field"><strong>HEX:</strong> {{ HEX }}</div>
                <div class="field"><strong>LAB:</strong> {{ LAB }}</div>
                <div class="field"><strong>LCH:</strong> {{ LCH }}</div>
                <div class="field"><strong>XYZ:</strong> {{ XYZ }}</div>
                <div class="field"><strong>CMYK:</strong> {{ CMYK }}</div>
                <div class="field"><strong>ACES:</strong> {{ ACES }}</div>
                <div class="field"><strong>ACEScg:</strong> {{ ACEScg }}</div>
                <div class="field"><strong>Linear sRGB:</strong> {{ LINSRGB }}</div>

                {% if PREVIEW %}
                  <div class="field" style="margin-top:10px;">
                    <strong>Prévia das cores (8 primeiras):</strong>
                  </div>
                  <div class="top-cores">
                    {% for c in PREVIEW %}
                      <div class="cor-item">
                        <span class="cor-swatch" style="background: {{ c.hex }}"></span>
                        <div class="cor-meta">
                          <div class="line"><strong>{{ c.hex }}</strong> — {{ '%0.2f' % c.perc }}%</div>
                          <div class="line">Pixels: {{ c.count }}</div>
                          <div class="line">RGB: {{ c.rgb }}</div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}

                {% if TODAS %}
                  <details style="margin-top:12px;">
                    <summary><strong>Todas as cores</strong> ({{ TODAS|length }} entradas)</summary>
                    <div class="top-cores" style="margin-top:8px;">
                      {% for c in TODAS %}
                        <div class="cor-item">
                          <span class="cor-swatch" style="background: {{ c.hex }}"></span>
                          <div class="cor-meta">
                            <div class="line"><strong>{{ c.hex }}</strong> — {{ '%0.4f' % c.perc }}%</div>
                            <div class="line">Pixels: {{ c.count }}</div>
                            <div class="line">RGB: {{ c.rgb }}</div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </details>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </div>
    </section>

    <!-- OPÇÃO 2: CALIBRAR -->
    <section class="section">
      <h2>2) Calibrar (ColorChecker)</h2>
      <form action="{{ url_for('routes.calibrar') }}" method="post" enctype="multipart/form-data">
        <label for="file-calib" class="file-label">Escolher imagem para calibração</label>
        <input id="file-calib" type="file" name="image" accept=".jpg,.jpeg,.png,.bmp,.tif,.tiff,.webp" required />
        <div class="checks">
          <label><input type="checkbox" name="as_reference" value="1" /> Usar como referência</label>
          <label><input type="checkbox" name="ignore_saved" value="1" /> Ignorar calibração existente</label>
          <label><input type="checkbox" name="purge_saved" value="1" /> Apagar calibrações anteriores</label>
        </div>
        <button type="submit">Calibrar</button>
      </form>

      <div class="result">
        {% if img_url %}<h3>Imagem enviada</h3><img src="{{ img_url }}" />{% endif %}
        {% if ann_url %}<h3>Detecção ArUco</h3><img src="{{ ann_url }}" />{% endif %}
        {% if warp_url %}<h3>Warp da paleta</h3><img src="{{ warp_url }}" />{% endif %}
        {% if warp_debug_url %}<h3>Warp (debug)</h3><img src="{{ warp_debug_url }}" />{% endif %}
        {% if warp_labels_url %}<h3>Warp (labels)</h3><img src="{{ warp_labels_url }}" />{% endif %}
        {% if calibrated_url %}<h3>Imagem calibrada</h3><img src="{{ calibrated_url }}" />{% endif %}
        {% if cfg %}<div class="divider"></div><h3>Configuração</h3><pre>{{ cfg | tojson(indent=2) }}</pre>{% endif %}
      </div>
    </section>

  </div>
  <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>
